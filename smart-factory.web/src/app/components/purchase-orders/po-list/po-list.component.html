<div class="p-6 bg-gray-50 min-h-screen">
  <!-- Header -->
  <div class="flex justify-between items-center mb-6">
    <div>
      <h1 class="text-3xl font-bold text-gray-800">Quản lý PO Gia Công</h1>
      <p class="text-gray-600 mt-1">Danh sách Purchase Orders từ chủ hàng</p>
    </div>
    <div class="flex gap-2">
      <button
        pButton
        label="Import Excel"
        icon="pi pi-file-excel"
        class="p-button-success"
        (click)="openImportDialog()">
      </button>
      <button
        pButton
        label="Tạo PO mới"
        icon="pi pi-plus"
        class="p-button-primary"
        (click)="createNewPO()">
      </button>
    </div>
  </div>

  <!-- Filter Section -->
  <div class="bg-white p-4 rounded-lg shadow-sm mb-6">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <!-- Status Filter -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Trạng thái</label>
        <p-dropdown
          [options]="statusOptions"
          [(ngModel)]="selectedStatus"
          optionLabel="label"
          optionValue="value"
          placeholder="Chọn trạng thái"
          (onChange)="onFilterChange()"
          [style]="{'width': '100%'}">
        </p-dropdown>
      </div>

      <!-- Version Type Filter -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Phiên bản</label>
        <p-dropdown
          [options]="versionTypeOptions"
          [(ngModel)]="selectedVersionType"
          optionLabel="label"
          optionValue="value"
          placeholder="Chọn phiên bản"
          (onChange)="onFilterChange()"
          [style]="{'width': '100%'}">
        </p-dropdown>
      </div>

      <!-- Customer Filter -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Chủ hàng</label>
        <p-dropdown
          [options]="customers"
          [(ngModel)]="selectedCustomerId"
          optionLabel="name"
          optionValue="id"
          placeholder="Chọn chủ hàng"
          (onChange)="onFilterChange()"
          [showClear]="true"
          [style]="{'width': '100%'}">
        </p-dropdown>
      </div>

      <!-- Search -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Tìm kiếm</label>
        <input
          type="text"
          pInputText
          [(ngModel)]="searchText"
          placeholder="Tìm mã PO, tên khách..."
          class="w-full">
      </div>
    </div>
  </div>

  <!-- PO Table -->
  <div class="bg-white rounded-lg shadow-sm">
    <p-table
      [value]="purchaseOrders"
      [loading]="loading"
      [paginator]="true"
      [rows]="20"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="Hiển thị {first} đến {last} trong tổng số {totalRecords} PO"
      [globalFilterFields]="['poNumber', 'customerName']"
      [filterDelay]="0"
      styleClass="p-datatable-striped">
      
      <!-- Template cho khi không có dữ liệu -->
      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="8" class="text-center py-8 text-gray-500">
            <i class="pi pi-inbox text-4xl mb-2"></i>
            <p>Không có PO nào</p>
          </td>
        </tr>
      </ng-template>

      <!-- Header -->
      <ng-template pTemplate="header">
        <tr>
          <th pSortableColumn="poNumber">
            Mã PO <p-sortIcon field="poNumber"></p-sortIcon>
          </th>
          <th pSortableColumn="customerName">
            Chủ hàng <p-sortIcon field="customerName"></p-sortIcon>
          </th>
          <th pSortableColumn="versionType">
            Phiên bản <p-sortIcon field="versionType"></p-sortIcon>
          </th>
          <th pSortableColumn="poDate">
            Ngày PO <p-sortIcon field="poDate"></p-sortIcon>
          </th>
          <th pSortableColumn="status">
            Trạng thái <p-sortIcon field="status"></p-sortIcon>
          </th>
          <th pSortableColumn="totalAmount" class="text-right">
            Tổng tiền <p-sortIcon field="totalAmount"></p-sortIcon>
          </th>
          <th class="text-center">SP</th>
          <th class="text-center">Thao tác</th>
        </tr>
      </ng-template>

      <!-- Body -->
      <ng-template pTemplate="body" let-po>
        <tr class="hover:bg-gray-50 cursor-pointer" (click)="viewPO(po.id)">
          <td>
            <span class="font-semibold text-blue-600">{{ po.poNumber }}</span>
          </td>
          <td>
            <div class="flex items-center">
              <i class="pi pi-building text-gray-400 mr-2"></i>
              {{ po.customerName }}
            </div>
          </td>
          <td>
            <p-tag
              [value]="getVersionTypeText(po.versionType)"
              [severity]="getVersionTypeSeverity(po.versionType)">
            </p-tag>
          </td>
          <td>
            {{ po.poDate | date: 'dd/MM/yyyy' }}
          </td>
          <td>
            <p-tag
              [value]="getStatusText(po.status)"
              [severity]="getStatusSeverity(po.status)">
            </p-tag>
          </td>
          <td class="text-right font-semibold">
            {{ po.totalAmount | currency: 'VND': 'symbol': '1.0-0' }}
          </td>
          <td class="text-center">
            <span class="inline-flex items-center justify-center bg-blue-100 text-blue-800 rounded-full px-2 py-1 text-xs font-medium">
              {{ po.productCount }}
            </span>
          </td>
          <td class="text-center">
            <button
              pButton
              icon="pi pi-eye"
              class="p-button-rounded p-button-text p-button-sm"
              pTooltip="Xem chi tiết"
              (click)="viewPO(po.id); $event.stopPropagation()">
            </button>
            <button
              *ngIf="po.versionType !== 'PRODUCTION'"
              pButton
              icon="pi pi-copy"
              class="p-button-rounded p-button-text p-button-sm"
              pTooltip="Clone version"
              (click)="cloneVersion(po); $event.stopPropagation()">
            </button>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>
</div>

<!-- Import Dialog -->
<p-dialog
  header="Import PO từ Excel"
  [(visible)]="showImportDialog"
  [modal]="true"
  [style]="{width: '600px'}"
  [draggable]="false"
  [resizable]="false">
  
  <div class="space-y-4">
    <!-- File Upload -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">
        File Excel <span class="text-red-500">*</span>
      </label>
      <p-fileUpload
        mode="basic"
        name="file"
        accept=".xlsx,.xls"
        [maxFileSize]="10000000"
        [auto]="false"
        chooseLabel="Chọn file Excel"
        (onSelect)="onFileSelect($event)"
        [disabled]="importLoading">
      </p-fileUpload>
      <div *ngIf="selectedFile" class="mt-2 flex items-center justify-between bg-blue-50 p-2 rounded">
        <div class="flex items-center">
          <i class="pi pi-file-excel text-green-600 mr-2"></i>
          <span class="text-sm">{{ selectedFile.name }}</span>
        </div>
        <button
          pButton
          icon="pi pi-times"
          class="p-button-text p-button-sm p-button-danger"
          (click)="clearFile()"
          [disabled]="importLoading">
        </button>
      </div>
      <small class="text-gray-500">Chỉ chấp nhận file .xlsx hoặc .xls (tối đa 10MB)</small>
    </div>

    <!-- Template Type -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">
        Loại Template <span class="text-red-500">*</span>
      </label>
      <div class="flex gap-2">
        <p-dropdown
          [options]="templateTypeOptions"
          [(ngModel)]="importForm.templateType"
          optionLabel="label"
          optionValue="value"
          placeholder="Chọn loại template"
          [style]="{'width': '100%'}"
          [disabled]="importLoading">
        </p-dropdown>
        <button
          pButton
          icon="pi pi-download"
          class="p-button-outlined p-button-info"
          pTooltip="Tải template mẫu"
          tooltipPosition="top"
          (click)="downloadTemplate(importForm.templateType)"
          [disabled]="importLoading">
        </button>
      </div>
      <small class="text-gray-500">
        <i class="pi pi-info-circle"></i> 
        Nhấn nút tải xuống để tải template Excel mẫu
      </small>
    </div>

    <!-- PO Number -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">
        Mã PO <span class="text-red-500">*</span>
      </label>
      <input
        type="text"
        pInputText
        [(ngModel)]="importForm.poNumber"
        placeholder="Nhập mã PO"
        class="w-full"
        [disabled]="importLoading">
    </div>

    <!-- Customer -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">
        Chủ hàng <span class="text-red-500">*</span>
      </label>
      <p-dropdown
        [options]="customers"
        [(ngModel)]="importForm.customerId"
        optionLabel="name"
        optionValue="id"
        placeholder="Chọn chủ hàng"
        [filter]="true"
        filterBy="name"
        [style]="{'width': '100%'}"
        [disabled]="importLoading">
      </p-dropdown>
    </div>

    <!-- PO Date -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">
        Ngày PO <span class="text-red-500">*</span>
      </label>
      <p-calendar
        [(ngModel)]="importForm.poDate"
        dateFormat="dd/mm/yy"
        [showIcon]="true"
        placeholder="Chọn ngày PO"
        [style]="{'width': '100%'}"
        [disabled]="importLoading">
      </p-calendar>
    </div>

    <!-- Expected Delivery Date -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">
        Ngày giao hàng dự kiến
      </label>
      <p-calendar
        [(ngModel)]="importForm.expectedDeliveryDate"
        dateFormat="dd/mm/yy"
        [showIcon]="true"
        placeholder="Chọn ngày giao hàng"
        [style]="{'width': '100%'}"
        [disabled]="importLoading">
      </p-calendar>
    </div>

    <!-- Notes -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">
        Ghi chú
      </label>
      <textarea
        pInputTextarea
        [(ngModel)]="importForm.notes"
        placeholder="Nhập ghi chú (nếu có)"
        rows="3"
        class="w-full"
        [disabled]="importLoading">
      </textarea>
    </div>
  </div>

  <ng-template pTemplate="footer">
    <button
      pButton
      label="Hủy"
      icon="pi pi-times"
      class="p-button-text"
      (click)="closeImportDialog()"
      [disabled]="importLoading">
    </button>
    <button
      pButton
      label="Import"
      icon="pi pi-upload"
      class="p-button-success"
      (click)="importFromExcel()"
      [disabled]="importLoading"
      [loading]="importLoading">
    </button>
  </ng-template>
</p-dialog>

<!-- Toast for notifications -->
<p-toast></p-toast>

