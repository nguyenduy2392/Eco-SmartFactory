<div class="card" *ngIf="purchaseOrder">
  <!-- Breadcrumb -->
  <div class="flex flex-wrap gap-2 mb-6">
    <a class="breadcrumb-link" routerLink="/dashboard">
      <i class="pi pi-home"></i>
      Trang chủ
    </a>
    <span class="breadcrumb-separator">/</span>
    <a class="breadcrumb-link" routerLink="/purchase-orders">Quản lý Đơn hàng</a>
    <span class="breadcrumb-separator">/</span>
    <span class="breadcrumb-current">{{ purchaseOrder.poNumber }}</span>
  </div>

  <!-- Header -->
  <div class="flex flex-column md:flex-row md:align-items-center justify-content-between gap-4 mb-6">
    <div class="flex flex-column gap-2">
      <div class="flex align-items-center gap-3">
        <h1 class="page-title m-0">Đơn hàng {{ purchaseOrder.poNumber }}</h1>
        <span 
          class="status-badge"
          [ngClass]="{
            'status-new': purchaseOrder.status === 'New',
            'status-inprogress': purchaseOrder.status === 'InProgress',
            'status-completed': purchaseOrder.status === 'Completed',
            'status-cancelled': purchaseOrder.status === 'Cancelled'
          }">
          {{ getStatusText(purchaseOrder.status) }}
        </span>
      </div>
      <p class="page-subtitle m-0">
        Được tạo ngày {{ purchaseOrder.poDate | date: 'dd/MM/yyyy' }}
      </p>
    </div>
    <div class="flex gap-2">
      <button
        pButton
        icon="pi pi-arrow-left"
        class="p-button-text p-button-secondary"
        pTooltip="Quay lại"
        (click)="goBack()">
      </button>
      <button
        *ngIf="purchaseOrder.versionType !== 'PRODUCTION'"
        pButton
        label="Clone Version"
        icon="pi pi-copy"
        class="p-button-outlined"
        (click)="cloneVersion()">
      </button>
      <button
        pButton
        label="Xuất Excel"
        icon="pi pi-download"
        class="p-button-outlined"
        (click)="exportToExcel()">
      </button>
      <button
        pButton
        label="Lưu thay đổi"
        icon="pi pi-save"
        class="p-button-primary">
      </button>
    </div>
  </div>

  <!-- Thông tin chung -->
  <div class="info-card mb-6">
    <div class="flex align-items-center gap-2 mb-4 pb-3 border-bottom-1 border-gray-200">
      <i class="pi pi-info-circle text-primary"></i>
      <h3 class="section-title m-0">Thông tin chung</h3>
    </div>

    <div class="grid">
      <!-- PO Number -->
      <div class="col-12 md:col-6 lg:col-3">
        <label class="field-label">Mã Đơn hàng (PO ID)</label>
        <input
          type="text"
          pInputText
          [value]="purchaseOrder.poNumber"
          [disabled]="true"
          class="w-full field-disabled">
      </div>

      <!-- Customer -->
      <div class="col-12 md:col-6 lg:col-3">
        <label class="field-label">Tên Khách hàng</label>
        <input
          type="text"
          pInputText
          [value]="purchaseOrder.customerName"
          class="w-full">
      </div>

      <!-- PO Date -->
      <div class="col-12 md:col-6 lg:col-3">
        <label class="field-label">Ngày tạo</label>
        <p-calendar
          [ngModel]="purchaseOrder.poDate"
          dateFormat="dd/mm/yy"
          [showIcon]="true"
          [style]="{'width': '100%'}">
        </p-calendar>
      </div>

      <!-- Status -->
      <div class="col-12 md:col-6 lg:col-3">
        <label class="field-label">Trạng thái</label>
        <p-dropdown
          [options]="[
            { label: 'Mới', value: 'New' },
            { label: 'Đang xử lý', value: 'InProgress' },
            { label: 'Hoàn thành', value: 'Completed' },
            { label: 'Hủy', value: 'Cancelled' }
          ]"
          [(ngModel)]="purchaseOrder.status"
          optionLabel="label"
          optionValue="value"
          [style]="{'width': '100%'}">
        </p-dropdown>
      </div>

      <!-- Version Type -->
      <div class="col-12 md:col-6 lg:col-3">
        <label class="field-label">Phiên bản</label>
        <div class="flex align-items-center h-full">
          <p-tag
            [value]="getVersionTypeText(purchaseOrder.versionType)"
            [severity]="getVersionTypeSeverity(purchaseOrder.versionType)">
          </p-tag>
        </div>
      </div>

      <!-- Expected Delivery Date -->
      <div class="col-12 md:col-6 lg:col-3" *ngIf="purchaseOrder.expectedDeliveryDate">
        <label class="field-label">Ngày giao hàng dự kiến</label>
        <p-calendar
          [ngModel]="purchaseOrder.expectedDeliveryDate"
          dateFormat="dd/mm/yy"
          [showIcon]="true"
          [style]="{'width': '100%'}">
        </p-calendar>
      </div>

      <!-- Template Type -->
      <div class="col-12 md:col-6 lg:col-3" *ngIf="purchaseOrder.templateType">
        <label class="field-label">Loại template</label>
        <div class="flex align-items-center h-full">
          <p-tag [value]="purchaseOrder.templateType" severity="secondary"></p-tag>
        </div>
      </div>

      <!-- Total Amount -->
      <div class="col-12 md:col-6 lg:col-3">
        <label class="field-label">Tổng giá trị</label>
        <div class="text-2xl font-bold text-primary">
          {{ purchaseOrder.totalAmount | currency: 'VND': 'symbol': '1.0-0' }}
        </div>
      </div>

      <!-- Notes -->
      <div class="col-12">
        <label class="field-label">Ghi chú</label>
        <textarea
          pInputTextarea
          [ngModel]="purchaseOrder.notes"
          placeholder="Nhập ghi chú thêm cho đơn hàng..."
          rows="2"
          class="w-full">
        </textarea>
      </div>
    </div>
  </div>

  <!-- Danh sách Sản phẩm & Operations -->
  <div class="flex flex-column gap-4">
    <div class="flex align-items-center justify-content-between">
      <h3 class="section-title m-0">Danh sách Sản phẩm</h3>
      <button
        pButton
        label="Thêm Sản phẩm"
        icon="pi pi-plus-circle"
        class="p-button-outlined p-button-primary">
      </button>
    </div>

    <!-- Products Table -->
    <div class="product-table-container">
      <table class="product-table">
        <thead>
          <tr>
            <th class="text-center" style="width: 60px;">#</th>
            <th>Sản phẩm</th>
            <th>Mã sản phẩm</th>
            <th>Mã SKU</th>
            <th class="text-center">Số lượng</th>
            <th class="text-right">Đơn giá</th>
            <th class="text-right">Thành tiền</th>
            <th class="text-center" style="width: 120px;">Thao tác</th>
          </tr>
        </thead>
        <tbody *ngIf="purchaseOrder.products && purchaseOrder.products.length > 0">
          <tr *ngFor="let product of purchaseOrder.products; let i = index" 
              class="product-row cursor-pointer"
              (click)="viewProductDetail(product.id)">
            <td class="text-center text-gray-500">{{ i + 1 }}</td>
            <td>
              <div class="flex align-items-center gap-3">
                <div class="product-image-placeholder">
                  <i class="pi pi-image"></i>
                </div>
                <div class="flex flex-column">
                  <span class="font-medium">{{ product.productName }}</span>
                </div>
              </div>
            </td>
            <td>
              <span class="font-mono text-sm font-semibold text-primary">{{ product.productCode }}</span>
            </td>
            <td>
              <span class="font-mono text-sm">{{ product.productCode }}</span>
            </td>
            <td class="text-center">
              <input
                type="number"
                pInputText
                [value]="product.quantity"
                class="quantity-input"
                (click)="$event.stopPropagation()">
            </td>
            <td class="text-right font-medium">
              <span *ngIf="product.unitPrice">
                {{ product.unitPrice | currency: 'VND': 'symbol': '1.0-0' }}
              </span>
              <span *ngIf="!product.unitPrice" class="text-gray-400">-</span>
            </td>
            <td class="text-right font-bold">
              {{ product.totalAmount | currency: 'VND': 'symbol': '1.0-0' }}
            </td>
            <td class="text-center">
              <div class="flex align-items-center justify-content-center gap-2">
                <button
                  pButton
                  icon="pi pi-pencil"
                  class="p-button-text p-button-sm action-btn"
                  pTooltip="Chỉnh sửa"
                  (click)="$event.stopPropagation()">
                </button>
                <button
                  pButton
                  icon="pi pi-trash"
                  class="p-button-text p-button-sm p-button-danger action-btn"
                  pTooltip="Xóa"
                  (click)="$event.stopPropagation()">
                </button>
              </div>
            </td>
          </tr>
        </tbody>
        <tbody *ngIf="!purchaseOrder.products || purchaseOrder.products.length === 0">
          <tr>
            <td colspan="8" class="text-center py-8 text-gray-500">
              <i class="pi pi-inbox text-6xl mb-3 block text-gray-300"></i>
              <p class="text-lg font-medium">Chưa có sản phẩm nào</p>
            </td>
          </tr>
        </tbody>
        <tfoot *ngIf="purchaseOrder.products && purchaseOrder.products.length > 0">
          <tr class="total-row">
            <td colspan="6" class="text-right font-bold">Tổng cộng:</td>
            <td class="text-right text-xl font-black text-primary">
              {{ purchaseOrder.totalAmount | currency: 'VND': 'symbol': '1.0-0' }}
            </td>
            <td></td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>

  <!-- Help Section -->
  <div class="help-section mt-6">
    <div class="flex gap-3 align-items-center">
      <div class="help-icon">
        <i class="pi pi-file text-2xl"></i>
      </div>
      <div>
        <h4 class="m-0 mb-1 font-bold">Hợp đồng & Văn bản</h4>
        <p class="m-0 text-sm text-gray-600">Xem và quản lý các tài liệu pháp lý liên quan đến đơn hàng này.</p>
      </div>
    </div>
    <button 
      pButton 
      label="Xem Tài liệu" 
      icon="pi pi-arrow-right"
      iconPos="right"
      class="p-button-text p-button-sm font-bold">
    </button>
  </div>
</div>

<!-- Loading state -->
<div *ngIf="loading" class="flex justify-content-center align-items-center" style="min-height: 60vh;">
  <p-progressSpinner></p-progressSpinner>
</div>

<!-- Toast for notifications -->
<p-toast></p-toast>

<!-- Confirmation dialog -->
<p-confirmDialog></p-confirmDialog>
