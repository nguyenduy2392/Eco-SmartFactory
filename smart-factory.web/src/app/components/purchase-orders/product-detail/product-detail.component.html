<div class="card" *ngIf="product">
  <!-- Breadcrumb -->
  <div class="flex flex-wrap gap-2 mb-6">
    <a class="breadcrumb-link cursor-pointer" (click)="goBack()">
      <i class="pi pi-home"></i>
      Trang chủ
    </a>
    <span class="breadcrumb-separator">/</span>
    <a class="breadcrumb-link cursor-pointer" routerLink="/purchase-orders">Quản lý Đơn hàng</a>
    <span class="breadcrumb-separator">/</span>
    <a class="breadcrumb-link cursor-pointer" (click)="goToPO()">{{ product.poNumber }}</a>
    <span class="breadcrumb-separator">/</span>
    <span class="breadcrumb-current">Chi tiết Sản phẩm</span>
  </div>

  <!-- Header -->
  <div class="flex flex-column md:flex-row md:align-items-end justify-content-between gap-4 mb-6">
    <div class="flex flex-column gap-2">
      <h1 class="page-title m-0">Chi tiết Sản phẩm</h1>
      <p class="page-subtitle m-0 max-w-full">
        Quản lý thông tin chi tiết và linh kiện cho sản phẩm trong đơn hàng #{{ product.poNumber }}
      </p>
    </div>
    <div class="flex gap-2">
      <button
        pButton
        label="In nhãn"
        icon="pi pi-print"
        class="p-button-outlined"
        (click)="printLabel()">
      </button>
      <button
        pButton
        label="Lưu thay đổi"
        icon="pi pi-save"
        class="p-button-primary"
        (click)="saveChanges()">
      </button>
    </div>
  </div>

  <!-- Product Information Card -->
  <div class="info-card mb-6">
    <div class="flex align-items-center justify-content-between mb-4 pb-3 border-bottom-1 border-gray-200">
      <div class="flex align-items-center gap-2">
        <i class="pi pi-box text-primary text-xl"></i>
        <h3 class="section-title m-0">Thông tin Sản phẩm</h3>
      </div>
      <p-tag [value]="product.status" severity="success"></p-tag>
    </div>

    <div class="grid">
      <!-- Product Image -->
      <div class="col-12 lg:col-4">
        <div class="flex flex-column gap-3">
          <div class="product-image-container">
            <img 
              *ngIf="product.imageUrl" 
              [src]="product.imageUrl" 
              [alt]="product.productName"
              class="w-full h-full object-fit-cover">
            <div *ngIf="!product.imageUrl" class="flex align-items-center justify-content-center h-full">
              <i class="pi pi-image text-6xl text-gray-300"></i>
            </div>
          </div>
          <button
            pButton
            label="Cập nhật hình ảnh"
            icon="pi pi-camera"
            class="p-button-outlined p-button-sm w-full"
            (click)="updateImage()">
          </button>
        </div>
      </div>

      <!-- Product Details -->
      <div class="col-12 lg:col-8">
        <div class="grid">
          <!-- Product Name -->
          <div class="col-12">
            <label class="field-label">Tên Sản phẩm</label>
            <input
              type="text"
              pInputText
              [(ngModel)]="product.productName"
              class="w-full font-semibold text-lg">
          </div>

          <!-- SKU -->
          <div class="col-12 md:col-6">
            <label class="field-label">Mã SKU</label>
            <div class="p-inputgroup">
              <span class="p-inputgroup-addon"><i class="pi pi-id-card"></i></span>
              <input
                type="text"
                pInputText
                [(ngModel)]="product.sku"
                class="w-full font-mono">
            </div>
          </div>

          <!-- Quantity -->
          <div class="col-12 md:col-6">
            <label class="field-label">Số lượng</label>
            <div class="p-inputgroup">
              <span class="p-inputgroup-addon"><i class="pi pi-hashtag"></i></span>
              <p-inputNumber
                [(ngModel)]="product.quantity"
                [showButtons]="true"
                [min]="0"
                class="w-full">
              </p-inputNumber>
            </div>
          </div>

          <!-- Material -->
          <div class="col-12 md:col-6">
            <label class="field-label">Chất liệu</label>
            <p-dropdown
              [(ngModel)]="product.material"
              [options]="[
                { label: 'Leather', value: 'Leather' },
                { label: 'Mesh Fabric', value: 'Mesh Fabric' },
                { label: 'Synthetic Leather', value: 'Synthetic Leather' },
                { label: 'Wool', value: 'Wool' }
              ]"
              optionLabel="label"
              optionValue="value"
              [style]="{'width': '100%'}">
            </p-dropdown>
          </div>

          <!-- Color -->
          <div class="col-12 md:col-6">
            <label class="field-label">Màu sắc</label>
            <div class="flex gap-2">
              <p-colorPicker [(ngModel)]="product.colorHex"></p-colorPicker>
              <input
                type="text"
                pInputText
                [(ngModel)]="product.color"
                class="flex-1">
            </div>
          </div>

          <!-- Description -->
          <div class="col-12">
            <label class="field-label">Mô tả / Ghi chú</label>
            <textarea
              pInputTextarea
              [(ngModel)]="product.description"
              rows="3"
              class="w-full">
            </textarea>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Components List -->
  <div class="flex flex-column gap-4">
    <div class="flex align-items-center justify-content-between">
      <h3 class="section-title m-0">Danh sách Linh kiện</h3>
      <button
        pButton
        label="Thêm Linh kiện"
        icon="pi pi-plus"
        class="p-button-outlined p-button-primary"
        (click)="addNewComponent()">
      </button>
    </div>

    <!-- Components Table -->
    <div class="product-table-container">
      <table class="product-table">
        <thead>
          <tr>
            <th>Tên Linh kiện</th>
            <th>Mã Linh kiện</th>
            <th>Chất liệu</th>
            <th class="text-center">Số lượng yêu cầu</th>
            <th class="text-center">Trạng thái</th>
            <th class="text-center" style="width: 120px;">Thao tác</th>
          </tr>
        </thead>
        <tbody *ngIf="product.components && product.components.length > 0">
          <tr *ngFor="let component of product.components" class="product-row cursor-pointer"
              (click)="viewComponentDetail(component.id)">
            <td>
              <div class="flex align-items-center gap-3">
                <div class="component-image-small">
                  <img 
                    *ngIf="component.imageUrl" 
                    [src]="component.imageUrl" 
                    [alt]="component.componentName">
                  <i *ngIf="!component.imageUrl" class="pi pi-wrench text-gray-400"></i>
                </div>
                <div class="flex flex-column">
                  <span class="font-bold">{{ component.componentName }}</span>
                  <span class="text-xs text-gray-500">{{ component.description }}</span>
                </div>
              </div>
            </td>
            <td>
              <span class="font-mono text-sm">{{ component.partId }}</span>
            </td>
            <td>{{ component.material }}</td>
            <td class="text-center">{{ component.quantityRequired }}</td>
            <td class="text-center">
              <p-tag 
                [value]="getStatusText(component.status)" 
                [severity]="getStatusSeverity(component.status)">
              </p-tag>
            </td>
            <td class="text-center">
              <button
                pButton
                label="Xem quy trình"
                icon="pi pi-arrow-right"
                iconPos="right"
                class="p-button-link p-button-sm"
                (click)="viewComponentDetail(component.id); $event.stopPropagation()">
              </button>
            </td>
          </tr>
        </tbody>
        <tbody *ngIf="!product.components || product.components.length === 0">
          <tr>
            <td colspan="6" class="text-center py-8 text-gray-500">
              <i class="pi pi-inbox text-6xl mb-3 block text-gray-300"></i>
              <p class="text-lg font-medium">Chưa có linh kiện nào</p>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Production Requirements -->
  <div class="help-section mt-6">
    <div class="flex gap-3 align-items-center">
      <div class="help-icon">
        <i class="pi pi-cog text-2xl"></i>
      </div>
      <div>
        <h4 class="m-0 mb-1 font-bold">Yêu cầu Sản xuất</h4>
        <p class="m-0 text-sm text-gray-600">Xem bản vẽ kỹ thuật và hướng dẫn lắp ráp cho SKU này.</p>
      </div>
    </div>
    <button 
      pButton 
      label="Tải xuống Specs" 
      icon="pi pi-download"
      iconPos="right"
      class="p-button-text p-button-sm font-bold">
    </button>
  </div>
</div>

<!-- Loading state -->
<div *ngIf="loading" class="flex justify-content-center align-items-center" style="min-height: 60vh;">
  <p-progressSpinner></p-progressSpinner>
</div>

