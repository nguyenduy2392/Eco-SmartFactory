<div class="card">
  <div class="flex justify-content-between align-items-center mb-4">
    <h2 class="text-2xl font-bold m-0">
      <i class="pi pi-check-circle mr-2"></i>
      Kiểm tra khả dụng nguyên vật liệu
    </h2>
  </div>

  <p-message 
    severity="info" 
    text="Kiểm tra xem nguyên vật liệu có đủ cho kế hoạch sản xuất hay không. Chỉ có thể kiểm tra với PO đã được phê duyệt cho PMC."
    class="mb-4">
  </p-message>

  <!-- Check Form -->
  <p-card class="mb-4">
    <div class="p-fluid">
      <div class="grid">
        <div class="col-12 md:col-6">
          <div class="field">
            <label for="po">Chọn PO đã phê duyệt <span class="text-red-500">*</span></label>
            <p-dropdown
              id="po"
              [options]="purchaseOrders"
              [(ngModel)]="selectedPOId"
              optionLabel="poNumber"
              optionValue="id"
              placeholder="Chọn PO..."
              [filter]="true"
              filterBy="poNumber,customerName"
              [style]="{'width': '100%'}"
              [loading]="loading"
              emptyMessage="Không có PO đã phê duyệt"
              [showClear]="true">
              <ng-template let-po pTemplate="item">
                <div class="flex justify-content-between align-items-center">
                  <div>
                    <strong>{{ po.poNumber }}</strong>
                    <div class="text-sm text-500">{{ po.customerName }}</div>
                  </div>
                  <div class="text-right">
                    <p-tag [value]="po.version" severity="info" [style]="{'font-size': '0.75rem'}"></p-tag>
                  </div>
                </div>
              </ng-template>
              <ng-template let-po pTemplate="selectedItem">
                <div *ngIf="po">
                  <strong>{{ po.poNumber }}</strong> - {{ po.customerName }} ({{ po.version }})
                </div>
              </ng-template>
            </p-dropdown>
          </div>
        </div>

        <div class="col-12 md:col-4">
          <div class="field">
            <label for="plannedQty">Số lượng kế hoạch sản xuất <span class="text-red-500">*</span></label>
            <p-inputNumber
              id="plannedQty"
              [(ngModel)]="plannedQuantity"
              [min]="1"
              [showButtons]="true"
              buttonLayout="horizontal"
              incrementButtonIcon="pi pi-plus"
              decrementButtonIcon="pi pi-minus"
              placeholder="Nhập số lượng..."
              [style]="{'width': '100%'}">
            </p-inputNumber>
          </div>
        </div>

        <div class="col-12 md:col-2 flex align-items-end">
          <div class="field w-full">
            <p-button
              label="Kiểm tra"
              icon="pi pi-search"
              (onClick)="checkAvailability()"
              [loading]="checkLoading"
              styleClass="w-full"
              severity="success">
            </p-button>
          </div>
        </div>
      </div>

      <div class="flex gap-2">
        <p-button
          label="Làm mới"
          icon="pi pi-refresh"
          (onClick)="resetForm()"
          styleClass="p-button-outlined"
          size="small">
        </p-button>
      </div>
    </div>
  </p-card>

  <!-- Result Section -->
  <div *ngIf="availabilityResult">
    <p-divider></p-divider>

    <!-- Overall Status -->
    <div class="mb-4">
      <div class="overall-status-card" [ngClass]="'status-' + availabilityResult.overallStatus.toLowerCase()">
        <div class="flex align-items-center justify-content-center gap-3 p-4">
          <i [class]="getOverallStatusIcon(availabilityResult.overallStatus)" class="status-icon"></i>
          <div class="text-center">
            <div class="status-label">{{ getOverallStatusLabel(availabilityResult.overallStatus) }}</div>
            <div class="text-sm text-600 mt-2">
              <i class="pi pi-calendar mr-2"></i>
              Kiểm tra lúc: {{ availabilityResult.checkDate | date:'dd/MM/yyyy HH:mm:ss' }}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Summary Cards -->
    <div class="grid mb-4">
      <div class="col-12 md:col-6">
        <p-card>
          <div class="flex flex-column align-items-center text-center">
            <i class="pi pi-shopping-cart text-5xl text-blue-500 mb-3"></i>
            <div class="text-500 mb-2 text-lg">Tổng yêu cầu</div>
            <div class="text-4xl font-bold text-primary">{{ availabilityResult.totalRequired }}</div>
          </div>
        </p-card>
      </div>
      <div class="col-12 md:col-6">
        <p-card>
          <div class="flex flex-column align-items-center text-center">
            <i class="pi pi-box text-5xl mb-3" 
               [ngClass]="availabilityResult.totalAvailable >= availabilityResult.totalRequired ? 'text-green-500' : 'text-red-500'"></i>
            <div class="text-500 mb-2 text-lg">Tổng khả dụng</div>
            <div class="text-4xl font-bold" 
                 [ngClass]="availabilityResult.totalAvailable >= availabilityResult.totalRequired ? 'text-green-500' : 'text-red-500'">
              {{ availabilityResult.totalAvailable }}
            </div>
          </div>
        </p-card>
      </div>
    </div>

    <!-- Material Details Table -->
    <p-card>
      <ng-template pTemplate="header">
        <div class="flex align-items-center gap-2 p-3">
          <i class="pi pi-list text-xl"></i>
          <span class="text-xl font-semibold">Chi tiết theo nguyên vật liệu</span>
        </div>
      </ng-template>

      <p-table
        [value]="availabilityResult.materialResults"
        [paginator]="true"
        [rows]="10"
        [rowsPerPageOptions]="[10, 25, 50]"
        styleClass="p-datatable-sm p-datatable-gridlines">
        <ng-template pTemplate="header">
          <tr>
            <th pSortableColumn="materialCode">
              Mã NVL
              <p-sortIcon field="materialCode"></p-sortIcon>
            </th>
            <th pSortableColumn="materialName">
              Tên NVL
              <p-sortIcon field="materialName"></p-sortIcon>
            </th>
            <th pSortableColumn="requiredQty" class="text-right">
              Yêu cầu
              <p-sortIcon field="requiredQty"></p-sortIcon>
            </th>
            <th pSortableColumn="inventoryQty" class="text-right">
              Tồn kho
              <p-sortIcon field="inventoryQty"></p-sortIcon>
            </th>
            <th pSortableColumn="poBaselineQty" class="text-right">
              Baseline (PO)
              <p-sortIcon field="poBaselineQty"></p-sortIcon>
            </th>
            <th pSortableColumn="availableQty" class="text-right">
              Khả dụng
              <p-sortIcon field="availableQty"></p-sortIcon>
            </th>
            <th pSortableColumn="shortage" class="text-right">
              Thiếu
              <p-sortIcon field="shortage"></p-sortIcon>
            </th>
            <th pSortableColumn="severity" class="text-center">
              Tình trạng
              <p-sortIcon field="severity"></p-sortIcon>
            </th>
          </tr>
        </ng-template>

        <ng-template pTemplate="body" let-mat>
          <tr [ngClass]="{'material-row-critical': mat.severity === 'CRITICAL', 'material-row-warning': mat.severity === 'WARNING'}">
            <td>
              <code>{{ mat.materialCode }}</code>
            </td>
            <td>{{ mat.materialName }}</td>
            <td class="text-right">
              <strong>{{ mat.requiredQty }}</strong>
            </td>
            <td class="text-right">{{ mat.inventoryQty }}</td>
            <td class="text-right">{{ mat.poBaselineQty }}</td>
            <td class="text-right">
              <strong [ngClass]="mat.shortage <= 0 ? 'text-green-600' : 'text-red-600'">
                {{ mat.availableQty }}
              </strong>
            </td>
            <td class="text-right">
              <strong class="text-red-600" *ngIf="mat.shortage > 0">{{ mat.shortage }}</strong>
              <span class="text-500" *ngIf="mat.shortage <= 0">-</span>
            </td>
            <td class="text-center">
              <p-tag
                [value]="getMaterialSeverityLabel(mat.severity)"
                [severity]="getMaterialSeveritySeverity(mat.severity)">
              </p-tag>
            </td>
          </tr>
        </ng-template>

        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="8" class="text-center">
              <div class="p-4">
                <i class="pi pi-inbox text-4xl text-400"></i>
                <p class="text-xl text-500 mt-3">Không có dữ liệu</p>
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </p-card>

    <!-- Action Messages -->
    <div class="mt-4">
      <p-message
        *ngIf="availabilityResult.overallStatus === 'FAIL'"
        severity="error"
        [closable]="false">
        <ng-template pTemplate>
          <div class="flex align-items-center">
            <i class="pi pi-times-circle text-2xl mr-3"></i>
            <div>
              <strong class="block mb-1">Không đủ nguyên vật liệu để sản xuất</strong>
              <p class="m-0">Vui lòng bổ sung nguyên vật liệu thiếu trước khi tạo kế hoạch sản xuất.</p>
            </div>
          </div>
        </ng-template>
      </p-message>

      <p-message
        *ngIf="availabilityResult.overallStatus === 'WARNING'"
        severity="warn"
        [closable]="false">
        <ng-template pTemplate>
          <div class="flex align-items-center">
            <i class="pi pi-exclamation-triangle text-2xl mr-3"></i>
            <div>
              <strong class="block mb-1">Nguyên vật liệu gần hết</strong>
              <p class="m-0">Có thể tiến hành sản xuất nhưng nên bổ sung nguyên vật liệu để đảm bảo suôn sẻ.</p>
            </div>
          </div>
        </ng-template>
      </p-message>

      <p-message
        *ngIf="availabilityResult.overallStatus === 'PASS'"
        severity="success"
        [closable]="false">
        <ng-template pTemplate>
          <div class="flex align-items-center justify-content-between">
            <div class="flex align-items-center">
              <i class="pi pi-check-circle text-2xl mr-3"></i>
              <div>
                <strong class="block mb-1">Đủ nguyên vật liệu</strong>
                <p class="m-0">Có thể tiến hành tạo kế hoạch sản xuất.</p>
              </div>
            </div>
            <p-button
              label="Tạo kế hoạch sản xuất"
              icon="pi pi-calendar-plus"
              severity="success"
              [disabled]="true"
              pTooltip="Chức năng này sẽ được triển khai trong phase tiếp theo"
              tooltipPosition="left">
            </p-button>
          </div>
        </ng-template>
      </p-message>
    </div>
  </div>

  <div *ngIf="!availabilityResult" class="text-center p-5">
    <i class="pi pi-info-circle text-5xl text-400 mb-3"></i>
    <p class="text-xl text-500">Chọn PO và nhập số lượng để kiểm tra khả dụng nguyên vật liệu</p>
  </div>
</div>

<p-toast></p-toast>

