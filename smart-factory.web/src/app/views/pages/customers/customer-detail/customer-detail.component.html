<div class="customer-detail-container">
  <div *ngIf="loading" class="flex justify-content-center align-items-center" style="min-height: 400px">
    <p-progressSpinner></p-progressSpinner>
  </div>

  <div *ngIf="!loading && customer">
    <!-- Header Card -->
    <div class="header-card">
      <div class="flex align-items-center gap-3">
        <button pButton
          icon="pi pi-arrow-left"
          class="p-button-soft p-button-primary p-button-rounded"
          (click)="goBack()"
          pTooltip="Quay lại"
          tooltipPosition="bottom">
        </button>
        <p-avatar 
          [label]="getInitials(customer.contactPerson || customer.name)"
          [style]="{'background-color': getAvatarColor(customer.contactPerson || customer.name), 'color': '#ffffff'}"
          shape="circle" 
          styleClass="customer-avatar">
        </p-avatar>
        <div class="flex-1">
          <div class="flex align-items-center gap-2">
            <h2 class="customer-name m-0">
              {{ customer.name }}
            </h2>
          </div>
        </div>
      </div>
    </div>

    <!-- Customer Information -->
    <div class="content-card">
      <p-tabView [(activeIndex)]="activeTabIndex">
      <!-- Tab 1: Danh sách PO -->
      <p-tabPanel header="Danh sách PO" leftIcon="pi pi-receipt">
        <app-po-list 
          [customerId]="customerId || undefined" 
          [hideHeader]="true">
        </app-po-list>
      </p-tabPanel>

      <!-- Tab 2: Nguyên vật liệu kho -->
      <p-tabPanel header="Nguyên vật liệu kho" leftIcon="pi pi-box">
        <p-message severity="info" text="Danh sách nguyên vật liệu trong kho của chủ hàng này." class="mb-3"></p-message>

        <!-- Filter -->
        <div class="mb-3">
          <p-dropdown 
            [options]="materialOptions" 
            [(ngModel)]="selectedMaterialId"
            name="selectedMaterialId"
            optionLabel="label" 
            optionValue="value"
            placeholder="Chọn nguyên vật liệu"
            [showClear]="true"
            styleClass="w-12rem"
            (onChange)="onMaterialFilterChange()">
          </p-dropdown>
        </div>

        <!-- Materials Table -->
        <div class="table-card">
          <div class="table-wrapper">
            <table class="materials-table">
              <thead>
                <tr>
                  <th>Mã VT</th>
                  <th>Tên vật tư</th>
                  <th>Loại</th>
                  <th class="text-right">Tồn kho</th>
                  <th class="text-right">Tồn tối thiểu</th>
                  <th>Đơn vị</th>
                  <th>Trạng thái</th>
                </tr>
              </thead>
              <tbody *ngIf="paginatedMaterials.length > 0">
                <tr *ngFor="let material of paginatedMaterials" class="table-row">
                  <td><code>{{ material.code }}</code></td>
                  <td>{{ material.name }}</td>
                  <td>{{ material.type }}</td>
                  <td class="text-right">
                    <strong [class.text-red-500]="material.currentStock < material.minStock">
                      {{ material.currentStock | number:'1.0-3' }}
                    </strong>
                  </td>
                  <td class="text-right">{{ material.minStock | number:'1.0-3' }}</td>
                  <td>{{ material.unit }}</td>
                  <td>
                    <p-tag
                      [value]="material.isActive ? 'Hoạt động' : 'Ngừng hoạt động'"
                      [severity]="material.isActive ? 'success' : 'danger'">
                    </p-tag>
                  </td>
                </tr>
              </tbody>
              <tbody *ngIf="paginatedMaterials.length === 0 && !materialsLoading">
                <tr>
                  <td colspan="7" class="text-center py-8">
                    <i class="pi pi-inbox text-6xl mb-3 block text-gray-300"></i>
                    <p class="text-lg font-medium text-gray-500">Không có nguyên vật liệu nào</p>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Pagination -->
          <div class="table-footer" *ngIf="filteredMaterials.length > 0">
            <div class="pagination-info">
              Hiển thị <span class="font-bold">{{ getFirstRecord() }}</span> đến
              <span class="font-bold">{{ getLastRecord() }}</span> trong tổng số
              <span class="font-bold">{{ filteredMaterials.length }}</span> nguyên vật liệu
            </div>
            <div class="flex gap-2 align-items-center">
              <button pButton label="Trang trước" icon="pi pi-chevron-left" class="p-button-soft p-button-primary p-button-sm"
                [disabled]="currentPage === 1" (click)="previousPage()">
              </button>
              <div class="flex gap-1 page-numbers">
                <button *ngFor="let page of getPageNumbers()" pButton [label]="page.toString()"
                  [class]="page === currentPage ? 'p-button-sm p-button-primary' : 'p-button-sm p-button-text'"
                  (click)="goToPage(page)">
                </button>
              </div>
              <button pButton label="Trang sau" icon="pi pi-chevron-right" iconPos="right" class="p-button-soft p-button-primary p-button-sm"
                [disabled]="currentPage >= getTotalPages()" (click)="nextPage()">
              </button>
            </div>
          </div>
        </div>
      </p-tabPanel>

      <!-- Tab 3: Kiểm tra tính khả dụng linh kiện -->
      <p-tabPanel header="Kiểm tra tính khả dụng linh kiện" leftIcon="pi pi-check-circle">
        <app-availability-check [customerId]="customerId || undefined"></app-availability-check>
      </p-tabPanel>
      </p-tabView>
    </div>
  </div>
</div>

<p-toast></p-toast>

